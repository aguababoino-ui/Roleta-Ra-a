<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Roleta de Classes</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
    body { background: #0c0c0c; font-family: Arial, sans-serif; text-align: center; color: white; }
    h1 { margin-top: 25px; font-size: 36px; text-shadow: 0 0 10px #00aaff; }
    .container { margin: auto; margin-top: 40px; width: 380px; padding: 20px; background: #1a1a1a; border-radius: 20px; box-shadow: 0 0 25px #0099ffaa; }
    .wheel-box { position: relative; width: 320px; height: 320px; margin: auto; background: #0a2a3a; border-radius: 20px; padding-top: 15px; box-shadow: inset 0 0 20px #000; }
    canvas { border-radius: 50%; width: 290px; height: 290px; background: #000; display: block; margin: 10px auto 0 auto; }
    .ponteiro { position: absolute; top: calc(50% - 150px); left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 30px solid white; filter: drop-shadow(0 0 5px #ffffff); z-index: 50; pointer-events: none; }
    button { margin-top: 25px; background: #0099ff; color: white; border: none; font-size: 20px; padding: 14px 28px; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; box-shadow: 0 0 10px #00bbff; }
    button[disabled] { opacity: 0.45; cursor: not-allowed; }
    button:hover { background: #00b7ff; box-shadow: 0 0 15px #00ddff; }
    #resultado { margin-top: 25px; font-size: 22px; font-weight: bold; text-shadow: 0 0 10px white; min-height: 28px; }
    #cronometro { margin-top: 10px; font-size: 18px; color: #00ffea; text-shadow: 0 0 5px #00bbff; min-height: 24px; }
    #msgBloqueio { margin-top: 12px; font-size: 16px; color: #ff6666; min-height: 24px; }
</style>
</head>
<body>

<h1>üéØ Roleta de Classes</h1>

<div class="container">
    <div class="wheel-box">
        <canvas id="wheel" width="300" height="300"></canvas>
        <div class="ponteiro"></div>
    </div>

    <button id="btnGirar">Girar Roleta</button>
    <div id="resultado">‚†Ä</div>
    <div id="cronometro"></div>
    <div id="msgBloqueio"></div>
</div>

<!-- Sons -->
<audio id="tick" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_f5075c2042.mp3?filename=tick-85736.mp3" preload="auto"></audio>
<audio id="win" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_fce346c94b.mp3?filename=success-1-6297.mp3" preload="auto"></audio>

<script>
/* ===========================
   CONFIG
   =========================== */
const LIMITE_GIROS = 3;
const TEMPO_RECUPERACAO = 20 * 60 * 60 * 1000; // 20h

/* ===========================
   ELEMENTOS (declarados cedo)
   =========================== */
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const btn = document.getElementById("btnGirar");
const resultadoDiv = document.getElementById("resultado");
const cronometroDiv = document.getElementById("cronometro");
const msgBloqueio = document.getElementById("msgBloqueio");
const tickSound = document.getElementById("tick");
const winSound = document.getElementById("win");

/* ===========================
   STORAGE KEYS
   =========================== */
const KEY_OWNER = "rc_ownerID_classes";
const KEY_TOKEN = "rc_browserToken";
const KEY_SPINS = "rc_spinsAvailable";
const KEY_NEXT = "rc_nextRecoveryTime";

/* ===========================
   UTIL
   =========================== */
function gerarID() {
    return 'xxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        let r = Math.random()*16|0;
        let v = c === 'x' ? r : (r&0x3|0x8);
        return v.toString(16);
    });
}

function podeUsarLocalStorage() {
    try {
        const key = "__rc_test__";
        localStorage.setItem(key, "1");
        localStorage.removeItem(key);
        return true;
    } catch (e) {
        return false;
    }
}

/* ===========================
   BLOQUEIO / MENSAGENS
   =========================== */
function bloquearInterface(msg) {
    btn.disabled = true;
    resultadoDiv.textContent = "";
    cronometroDiv.textContent = "";
    msgBloqueio.textContent = msg || "Acesso bloqueado.";
    try { canvas.style.pointerEvents = "none"; } catch(e) {}
}

/* ===========================
   CONTROLE DE ACESSO
   =========================== */
function inicializarControleAcesso() {
    if (!podeUsarLocalStorage()) {
        bloquearInterface("‚ùå Modo privado ou LocalStorage desabilitado ‚Äî a roleta foi bloqueada.");
        throw new Error("localStorage_unavailable");
    }

    let owner = localStorage.getItem(KEY_OWNER);
    let token = localStorage.getItem(KEY_TOKEN);

    if (!owner) {
        // primeiro uso: marca este navegador como dono
        owner = gerarID();
        token = owner;
        localStorage.setItem(KEY_OWNER, owner);
        localStorage.setItem(KEY_TOKEN, token);
        // define spins iniciais
        localStorage.setItem(KEY_SPINS, String(LIMITE_GIROS));
        localStorage.removeItem(KEY_NEXT);
        return;
    }

    // owner existe, verificar token local (marca do mesmo browser)
    if (!token || token !== owner) {
        bloquearInterface("‚ùå Roleta s√≥ funciona no navegador original onde foi ativada. Use o navegador onde voc√™ ativou pela primeira vez.");
        throw new Error("different_browser_blocked");
    }
}

/* ===========================
   SPINS / RECUPERA√á√ÉO
   =========================== */
function lerSpins() {
    try {
        const v = Number(localStorage.getItem(KEY_SPINS));
        if (Number.isNaN(v)) return LIMITE_GIROS;
        return Math.max(0, Math.min(LIMITE_GIROS, Math.floor(v)));
    } catch (e) {
        return LIMITE_GIROS;
    }
}
function salvarSpins(n) { localStorage.setItem(KEY_SPINS, String(Math.max(0, Math.min(LIMITE_GIROS, Math.floor(n))))); }

function lerNext() {
    try {
        const v = Number(localStorage.getItem(KEY_NEXT));
        if (!v || Number.isNaN(v)) return null;
        return v;
    } catch (e) { return null; }
}
function salvarNext(t) {
    if (t === null || t === undefined) localStorage.removeItem(KEY_NEXT);
    else localStorage.setItem(KEY_NEXT, String(Number(t)));
}

function processarRecuperacao() {
    let spins = lerSpins();
    let next = lerNext();

    if (spins >= LIMITE_GIROS) {
        salvarNext(null);
        return;
    }

    const agora = Date.now();

    if (!next) {
        // define quando ser√° a pr√≥xima recupera√ß√£o
        salvarNext(agora + TEMPO_RECUPERACAO);
        return;
    }

    if (agora < next) return;

    // j√° passou: quantas recupera√ß√µes se passaram desde 'next'?
    const delta = agora - next;
    const recuperados = 1 + Math.floor(delta / TEMPO_RECUPERACAO);
    let novoSpins = spins + recuperados;

    if (novoSpins >= LIMITE_GIROS) {
        salvarSpins(LIMITE_GIROS);
        salvarNext(null);
    } else {
        salvarSpins(novoSpins);
        salvarNext(next + recuperados * TEMPO_RECUPERACAO);
    }
}

function atualizarUI() {
    try {
        processarRecuperacao();
    } catch (e) {
        bloquearInterface("Erro no armazenamento ‚Äî roleta bloqueada.");
        return;
    }

    const spins = lerSpins();
    const next = lerNext();

    if (spins > 0) {
        btn.disabled = false;
        btn.textContent = `Girar Roleta (${spins})`;
        cronometroDiv.textContent = "";
        msgBloqueio.textContent = "";
    } else {
        btn.disabled = true;
        btn.textContent = "Acabou os giros";
        if (next) {
            const faltam = Math.max(0, next - Date.now());
            const h = Math.floor(faltam / 1000 / 60 / 60);
            const m = Math.floor((faltam / 1000 / 60) % 60);
            const s = Math.floor((faltam / 1000) % 60);
            cronometroDiv.textContent = `Pr√≥ximo giro em ${h}h ${m}m ${s}s`;
        } else {
            cronometroDiv.textContent = `Pr√≥ximo giro em 20h`;
        }
    }
}

/* ===========================
   ROLETA (desenho e giro)
   =========================== */
const classes = [
    { nome: "ü§¢ Pebleu",       cor: "#4d4d4d" },
    { nome: "üë®‚Äçüåæ Alde√£o",     cor: "#7dff00" },
    { nome: "üíé Nobre",        cor: "#0099ff" },
    { nome: "üè∞ Realeza",      cor: "#d4af37" },
    { nome: "üåÄ Zogratis",     cor: "#8000ff" },
    { nome: "üëë Grinberryall", cor: "#ff00c8" }
];

let setores = [];
let angulo = 0;
let animando = false;
let ultimoTick = -1;

function calcularSetores() {
    const total = classes.length;
    setores = classes.map((r,i) => {
        const inicio = (i/total)*2*Math.PI;
        const fim = ((i+1)/total)*2*Math.PI;
        return { nome: r.nome, cor: r.cor, inicio, fim };
    });
}

function desenhar() {
    const w = canvas.width, h = canvas.height;
    const cx = w/2, cy = h/2, radius = Math.min(w,h)/2 - 10;
    ctx.clearRect(0,0,w,h);
    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(angulo);

    setores.forEach(s => {
        ctx.beginPath();
        ctx.fillStyle = s.cor;
        ctx.moveTo(0,0);
        ctx.arc(0,0,radius, s.inicio, s.fim);
        ctx.fill();

        ctx.save();
        ctx.rotate((s.inicio + s.fim)/2);
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.font = "16px Arial";
        ctx.fillText(s.nome, radius * 0.6, 6);
        ctx.restore();
    });

    ctx.beginPath();
    ctx.fillStyle = "#111";
    ctx.arc(0,0, radius * 0.22, 0, Math.PI*2);
    ctx.fill();

    ctx.restore();
}

function pegarSetorAtual() {
    const anguloPonteiro = 3 * Math.PI / 2;
    let ang = (anguloPonteiro - angulo) % (2*Math.PI);
    if (ang < 0) ang += 2*Math.PI;
    return setores.findIndex(s => ang >= s.inicio && ang < s.fim);
}

/* ===========================
   GIRAR LOGICA
   =========================== */
function girarRoleta() {
    if (animando) return;

    let spins = lerSpins();
    if (spins <= 0) {
        atualizarUI();
        return;
    }

    // consome 1 spin
    spins = spins - 1;
    salvarSpins(spins);

    // se agora abaixo do limite, garante next recovery
    if (spins < LIMITE_GIROS) {
        if (!lerNext()) salvarNext(Date.now() + TEMPO_RECUPERACAO);
    }

    atualizarUI();

    animando = true;
    resultadoDiv.textContent = "Girando...";

    let velocidade = Math.random() * 4 + 5;
    const desacel = 0.015;

    function anim() {
        angulo += velocidade * 0.02;
        velocidade -= desacel;
        if (velocidade < 0.05) velocidade = 0;

        desenhar();

        const idx = pegarSetorAtual();
        if (idx !== ultimoTick) {
            try { tickSound.currentTime = 0; tickSound.play(); } catch(e) {}
            ultimoTick = idx;
        }

        if (velocidade > 0) {
            requestAnimationFrame(anim);
        } else {
            animando = false;
            const final = pegarSetorAtual();
            resultadoDiv.textContent = "Resultado: " + setores[final].nome;
            try { winSound.currentTime = 0; winSound.play(); } catch(e) {}
            atualizarUI();
        }
    }

    anim();
}

/* ===========================
   INICIALIZA√á√ÉO
   =========================== */
function iniciar() {
    try {
        inicializarControleAcesso();
    } catch (e) {
        // j√° bloqueou a interface dentro da fun√ß√£o
        return;
    }

    calcularSetores();
    desenhar();
    atualizarUI();

    btn.addEventListener("click", girarRoleta);
    setInterval(atualizarUI, 1000);
}

if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", iniciar);
} else {
    iniciar();
}
</script>

</body>
</html>


